<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.webgis.mapper.TourMapper">

    <!--    几何查询点-->
    <select id="queryPoint" resultType="com.webgis.entity.table.ScenicEntity">
        select *
        from info
        WHERE x >= #{xmin}
          and y >= #{ymin}
          and x &lt;= #{xmax}
          and y &lt;= #{ymax}
    </select>

    <!--    景点查询所有信息-->
    <select id="queryAll" resultType="com.webgis.entity.table.ScenicEntity">
        select *
        from info
    </select>

    <!--    查询景点分数及评论个数-->
    <select id="coName" resultType="com.webgis.entity.table.CoScore">
        select *
        from coscore
        where name = #{name}
    </select>

    <!--    删除信息不对应的景点-->
    <delete id="deSC" parameterType="com.webgis.entity.table.ScenicEntity">
        delete
        from info
        where id = #{id}
    </delete>

    <!--    更新景点热度和分数-->
    <update id="upSH" parameterType="com.webgis.entity.table.ScenicEntity">
        update info
        set hot=#{hot},
            score=#{score}
        where id = #{id}
    </update>

    <!--查询景点个数-->
    <select id="coPC" resultType="com.webgis.entity.table.CoPC">
        select *
        from compc
        where name = #{name}
    </select>

    <!--更新评论省、市-->
    <update id="upPC" parameterType="com.webgis.entity.table.CoPC">
        update compc
        set province= #{sheng},
            city= #{shi}
        where name = #{name}
    </update>

    <!--获取评论城市列表-->
    <select id="cRank" resultType="map">
        select distinct city
        from comment
    </select>

    <!--    查询某城市有多少条评论-->
    <select id="cCount" resultType="int">
        select count(*)
        from comment
        where city = #{city}
    </select>

    <!--    新表插入城市和评论数-->
    <insert id="inCC" parameterType="com.webgis.entity.table.CityRank">
        insert into cityrank(id, city, comcount)
        values (#{id}, #{city}, #{comcount})
    </insert>

    <!--    查询该城市下的景点名及分数-->
    <select id="cScenicCount" resultType="com.webgis.entity.table.ScenicEntity">
        select name, score
        from info
        where city = #{city}
    </select>

    <!--获取城市表城市名-->
    <select id="getcity" resultType="com.webgis.entity.table.CityRank">
        select city
        from cityrank
    </select>

    <!--更新城市表的评论数和分数-->
    <update id="upCityScore" parameterType="com.webgis.entity.table.CityRank">
        update cityrank
        set sccount = #{sccount},
            scscore = #{scscore}
        where city = #{city}
    </update>

    <!--查询排名前十的城市-->
    <select id="cityRank" resultType="com.webgis.entity.table.CityRank">
        select *
        from cityrank
        order by hotrank limit 0,10
    </select>

    <!--获取点数据-->
    <select id="getPoint" resultType="com.webgis.entity.table.PointEntity">
        select *
        from point
    </select>

    <!--评论表中添加经纬度-->
    <update id="upLaLg" parameterType="com.webgis.entity.table.CommentEntity">
        update comment
        set longitude = #{longitude},
            latitude  = #{latitude}
        where name = #{name}
    </update>

    <!--查询景点经纬度-->
    <select id="queryLL" resultType="com.webgis.entity.table.ScenicEntity">
        select name, x, y
        from scenic
    </select>

    <!--查询评论坐标点-->
    <select id="comPoint" resultType="com.webgis.entity.table.ComPoint">
        select *
        from compoint
    </select>

    <!--依据景点名称获取评论所有信息前20条-->
    <select id="getComment" resultType="com.webgis.entity.table.CommentEntity">
        select *
        from comment
        where name = #{name} limit 0,20
    </select>

    <!--依据景点名称获取评论-->
    <select id="getCom" resultType="com.webgis.entity.table.CommentEntity">
        select score, date
        from comment
        where name = #{name}
    </select>

    <!--南京景点推荐-->
    <select id="nanjingRe" resultType="com.webgis.entity.table.NanJingEntity">
        select *
        from 南京景点
        order by ${preference} ASC
    </select>

    <!--城市评论-->
    <select id="cityCom" resultType="com.webgis.entity.table.CommentEntity">
        select *
        from comment
        where city = #{city} limit 0,20
    </select>

    <!--获取表中最新的时间-->
    <select id="lastCom" resultType="com.webgis.entity.table.CommentEntity">
        select date
        from comment
        ORDER BY date DESC LIMIT 1
    </select>

    <select id="commentDay" resultType="com.webgis.entity.CommentDay">
        SELECT date, count(*)as count, sum(score=5)as score
        FROM 评论总表
        GROUP BY date
        HAVING DATE_FORMAT(date
             , '%Y-%m') BETWEEN #{startDate}
           AND #{endDate}
        ORDER BY date
    </select>

    <select id="ScenicDay" resultType="com.webgis.entity.ScenicDay">
        SELECT name, count(*)as count
        FROM comment
        WHERE date =#{time}
        GROUP BY name
        ORDER BY count DESC
            LIMIT 0, 10
    </select>

    <select id="travelDay" resultType="com.webgis.entity.CommentDay">
        SELECT time_release as date, count(*)as count
        FROM `游记总表`
        GROUP BY time_release
        HAVING DATE_FORMAT(time_release
             , '%Y-%m') BETWEEN #{startDate}
           AND #{endDate}
        ORDER BY time_release
    </select>


    <select id="get1000" resultType="com.webgis.entity.table.ScenicEntity">
        SELECT *
        FROM dbo.scenicInfo
        WHERE id = 488
    </select>

    <select id="getForm" resultType="com.webgis.entity.table.ScenicEntity">
        <if test="page==1">
            SELECT TOP(9)*
            FROM dbo.scenicInfo
            ORDER by id
        </if>
        <if test="page>1">
            SELECT top(9)*
            FROM dbo.scenicInfo
            WHERE id
            NOT IN (SELECT TOP(999)id
            FROM dbo.scenicInfo
            ORDER by id)
            ORDER by id
        </if>
    </select>

    <select id="searchForm" resultType="com.webgis.entity.table.ScenicEntity">
        <if test="page==1">
            SELECT TOP(#{count})*
            FROM dbo.scenicInfo
            WHERE Name LIKE CONCAT('%',#{model},'%')
            ORDER by id
        </if>
        <if test="page>1">
            SELECT top(#{count})*
            FROM dbo.scenicInfo
            WHERE Name LIKE CONCAT('%',#{model},'%')
            id NOT IN (SELECT TOP(#{jisuan})id FROM dbo.scenicInfo ORDER by id)
            ORDER by id
        </if>
    </select>


</mapper>
